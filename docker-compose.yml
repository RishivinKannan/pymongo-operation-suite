version: '3.8'

services:
  # MongoDB with replica set for transaction testing
  mongodb:
    image: mongo:4.0
    container_name: pymongo-mongodb
    # command: ["--replSet", "rs0", "--bind_ip_all"]
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: testdb
    # volumes:
    #   - ./init-replica.sh:/docker-entrypoint-initdb.d/init-replica.sh
    healthcheck:
      test: echo "try { rs.status() } catch (err) { rs.initiate({_id:'rs0',members:[{_id:0,host:'mongodb:27017'}]}) }" | mongosh --port 27017 --quiet
      interval: 5s
      timeout: 30s
      start_period: 0s
      retries: 30
    networks:
      - pymongo-network

  # Jaeger for OpenTelemetry traces
  jaeger:
    image: jaegertracing/all-in-one:1.52
    container_name: pymongo-jaeger
    ports:
      - "16686:16686" # Jaeger UI
      - "4317:4317" # OTLP gRPC receiver
      - "4318:4318" # OTLP HTTP receiver
      - "14268:14268" # Jaeger collector
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    networks:
      - pymongo-network

  # PyMongo Operations Suite Application
  app:
    build: .
    image: pymongo-operations-suite
    container_name: pymongo-operations-suite
    ports:
      - "5000:5000"
    env_file:
      - .env
    environment:
      # Override for Docker networking
      - MONGODB_URI=mongodb://mongodb:27017/
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
    depends_on:
      - mongodb
      - jaeger
    networks:
      - pymongo-network

volumes:
  mongodb_data:


networks:
  pymongo-network:
    driver: bridge
